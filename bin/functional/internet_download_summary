#!/bin/bash

file_=/home/amir/._amb

while [ $# -gt 0 ]; do
	case "$1" in
		-s|--sleep_time)
			sleep_time="$2"
			;;
		-e|--extention)
			extention="$2"
			;;
		-h|--help)
			echo -e "
	Usage:

	-s, --sleep_time ........ sleep time (in seconds)
														default is '60'
	-e, --extention  ........ extention
								default is 'mp4'
							    You can pass multiple such as '--extention mp4,mkv,webm'
	-h, --help  ............. help page
	"
	exit
			;;
		*)
			echo -e "
		***************************
		* Error: Invalid argument.*
		***************************
			"
			exit 1
	esac
	shift
	shift
done

echo ""
if [[ -z $sleep_time ]]; then
	echo -e ">>> 'sleep_time' argument not passed, so default (60) is set.\n"
	sleep_time=60
fi

if [[ -z $extention ]]; then
	echo -e ">>> 'extention' argument not passed, so default 'mp4' is set.\n"
	extention=mp4
fi



SUM=`du -shL -BM | sed 's/M..//g'`



IFS=$'\n'
# before_files=`ls -I "*.part" -I "*.ytdl" | wc -l`
# if [[ $( echo $extention | grep -o , ) ]]
multiple_extentions=false
if [[ $(echo $extention | grep -o , | wc -l ) -gt 0 ]] ; then
	multiple_extentions=true
fi

before_files=0
if $multiple_extentions; then
	IFS=,
	for e in $extention ; do 
		before_files=$(bc <<< $before_files+$(ls *.$e | wc -l))
	done
else
	before_files=$(ls *.$extention | wc -l)
fi

c=0
while :; do
	current=`du -shL -BM | sed 's/M..//g'`
	if [[ $? != 0 ]]; then
		sleep 1s
		# continue
	fi
	incremental=$(( $current - $SUM ))
	SUM=$current
	# after_files=`ls -I "*.part" -I "*.ytdl" | wc -l`

	after_files=0
	if $multiple_extentions; then
		IFS=,
		for e in $extention ; do 
			after_files=$(bc <<< $after_files+$(ls *.$e | wc -l))
		done
	else
		after_files=$(ls *.$extention | wc -l)
	fi

	
	echo "Time,IncremenalSize,FullSize,IncremenalFilesQty,AllFilesQty,.part Qty" > $file_
	echo "`date +%H:%M`,$incremental,$SUM,`bc <<< $after_files-$before_files`,$after_files, `ls *.part | wc -l`" >> $file_
	let "c++"
	if [[ $c == 1 ]]; then
		cat $file_ | column -t -s, | grep --color "\|Time\|IncremenalSize\|FullSize\|IncremenalFilesQty\|AllFilesQty\|.part Qty"
	else
		cat $file_ | column -t -s, | tail -1
	fi
	if [[ $c == 25 ]]; then
		c=0
	fi
	sleep $sleep_time
done

rm -f $file_