#!/usr/bin/ipython3
from termcolor import colored
print(colored("\n\n******** Kurulus usman ********\n", 'red'))
import os
import requests
from bs4 import BeautifulSoup
_file_name_ = "/home/amir/github/Amir-personal/.kurulus_usman_last_downloaded.txt"
s = BeautifulSoup(requests.get("https://ardirilisertugrul.net/Kurulus-Osman/1.php?id=1").text, 'lxml')
# n = max([int(i.text.strip("episode ")) for i in s.select("button", {"class" : "btn btn-info"}) if i.text.startswith("episode") ])
n = 0
for i in s.select("button", {"class" : "btn btn-info"}):
	i = i.text.strip().split()
	if i and  i[-1].isnumeric():
		i = int(i[-1])
		if i > n:
			n = i
last_vid_num = int(open(_file_name_, 'r').read().strip())
last_vid = f"https://ardirilisertugrul.net/Kurulus-Osman/1.php?id={last_vid_num}"

if last_vid_num+1 < n:	
	inp_ = input(f"Last video downloaded is {last_vid_num}, and now the episode #{n} is ready to download, are you sure to download #{n} before the missing one? [y|n]   ")
	if inp_.lower().strip() != 'y':
		import sys
		sys.exit()

print("Last video page:", last_vid)
print("""\n\n#############################################################
####-----------------""", end="")

if n > last_vid_num:
	print(colored(" CONGRATULATIONS", 'red'), end="")                                                                                                               
else:
	print(colored("--- NO NEW VIDEO", 'red'), end="")

print(""" -------------------####
#############################################################\n""")

if n > last_vid_num:
	q = BeautifulSoup(requests.get("https://ardirilisertugrul.net/Kurulus-Osman/1.php?id="+str(n)).text, 'lxml')                                               
	if 'Next Part soon..' in q.text:
		print("\n **** Full video NOT uploaded yet ****\n")
		os.popen(f"firefox https://ardirilisertugrul.net/Kurulus-Osman/1.php?id=" + str(n))
	else:
		ans_ = input(f"\n\nAre you need to update {_file_name_} file?\n[y|n]  ")
		if ans_ == "y":
			open(_file_name_, 'w').write(str(n))
		ans_ = input(f"\n\nAre you to download LATEST video?\n[y|n] ")
		if ans_ == "y":
			for i in q.find("div", {"class" : "WatchSection activee text-center"}).select("a"):
				try:
					l = i['href']
					if "ok.ru" in l: 
						l = 'https:' + l.replace("videoembed", "video")
						break
				except:
					pass
			com = f"youtube-dl -f18 {l} || youtube-dl -f sd {l} || youtube-dl -f hd {l} || youtube-dl {l}"
			print(f"\nDownload command: {com}\n\n\n")
			os.system(com)
	print()


